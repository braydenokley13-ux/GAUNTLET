<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOW Boss Sim - Economic Summit</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #2d3561 0%, #c05c7e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        /* SETUP SCREEN */
        .setup-screen {
            padding: 50px;
            text-align: center;
        }
        
        .setup-screen h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        .player-setup {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            max-width: 800px;
            margin: 40px auto;
        }
        
        .player-card {
            background: #f8f9fa;
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 30px;
        }
        
        .player-card h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .player-card input {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .player-card label {
            display: block;
            text-align: left;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .scenario-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
            text-align: left;
        }
        
        .scenario-box h3 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* GAME SCREEN */
        .game-screen {
            display: none;
        }
        
        .game-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: calc(100vh - 160px);
        }
        
        .main-area {
            padding: 30px;
            overflow-y: auto;
        }
        
        .sidebar {
            background: #f8f9fa;
            border-left: 3px solid #667eea;
            display: flex;
            flex-direction: column;
        }
        
        .round-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .round-info h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        
        .timer {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .city-status {
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .city-status h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .stat-label {
            font-weight: 600;
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: #333;
        }
        
        .team-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow: hidden;
        }
        
        .team-chat h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .chat-messages {
            flex: 1;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            margin-bottom: 15px;
            max-height: 200px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: #e7f3ff;
        }
        
        .chat-message.player1 {
            background: #d4edda;
        }
        
        .chat-message.player2 {
            background: #cce5ff;
        }
        
        .chat-sender {
            font-weight: bold;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        .chat-input-area input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .chat-input-area button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .phase-title {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .phase-title h2 {
            font-size: 1.8em;
            margin-bottom: 8px;
        }
        
        .ai-statement-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .ai-statement {
            background: #f8f9fa;
            border-left: 5px solid #667eea;
            padding: 20px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .ai-statement.wealthy {
            border-left-color: #ffd700;
        }
        
        .ai-statement.factory {
            border-left-color: #dc3545;
        }
        
        .ai-statement.green {
            border-left-color: #28a745;
        }
        
        .ai-statement h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .ai-icon {
            font-size: 1.5em;
        }
        
        .ai-statement p {
            color: #333;
            line-height: 1.6;
        }
        
        .proposal-area {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .proposal-area h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .proposal-area textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .action-btn.primary {
            background: #667eea;
            color: white;
        }
        
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-btn.success {
            background: #28a745;
            color: white;
        }
        
        .action-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .alliance-offer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .alliance-offer h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .budget-allocator {
            background: white;
            border: 3px solid #667eea;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .budget-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .budget-item label {
            font-weight: 600;
            color: #333;
        }
        
        .budget-item input {
            width: 120px;
            padding: 8px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: right;
        }
        
        .budget-total {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .ai-reaction {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .ai-reaction.positive {
            background: #d4edda;
            color: #155724;
        }
        
        .ai-reaction.negative {
            background: #f8d7da;
            color: #721c24;
        }
        
        .ai-reaction.neutral {
            background: #fff3cd;
            color: #856404;
        }
        
        .crisis-banner {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(220, 53, 69, 0); }
        }
        
        .crisis-banner h2 {
            font-size: 2em;
            margin-bottom: 15px;
        }
        
        .vote-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .vote-card {
            background: #f8f9fa;
            border: 3px solid #ddd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .vote-card.yes {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .vote-card.no {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .vote-card h4 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .vote-result {
            font-size: 2em;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .results-screen {
            display: none;
            padding: 50px;
            text-align: center;
        }
        
        .results-screen h2 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        
        .claim-code {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            font-size: 2em;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 30px 0;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .claim-code:hover {
            transform: scale(1.05);
        }
        
        .score-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
            text-align: left;
        }
        
        .score-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }
        
        .score-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .score-item:last-child {
            border-bottom: none;
        }
        
        .hidden {
            display: none !important;
        }
        
        .info-box {
            background: #e7f3ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .private-message {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .private-message h4 {
            color: #856404;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è ECONOMIC SUMMIT</h1>
            <p>BOW Mastery Layer - Boss Sim Challenge</p>
        </div>
        
        <!-- SETUP SCREEN -->
        <div class="setup-screen" id="setupScreen">
            <h2>Welcome to the Regional Economic Summit</h2>
            
            <div class="scenario-box">
                <h3>üéØ The Crisis</h3>
                <p>Five cities in a regional alliance are facing an economic recession. Your team represents one of these cities and must negotiate with three AI-controlled cities to create a Regional Recovery Plan.</p>
                <p style="margin-top: 15px;"><strong>Your Mission:</strong> Secure at least $25M from the $100M regional fund, pass a favorable trade agreement, and keep your city's approval above 50%. You need 3 out of 4 votes to pass any plan.</p>
            </div>
            
            <div class="player-setup">
                <div class="player-card">
                    <h3>üë§ Player 1</h3>
                    <label>Your Name:</label>
                    <input type="text" id="player1Name" placeholder="Enter your name">
                    <label>Initials (for claim code):</label>
                    <input type="text" id="player1Initials" placeholder="AB" maxlength="2">
                </div>
                
                <div class="player-card">
                    <h3>üë§ Player 2</h3>
                    <label>Your Name:</label>
                    <input type="text" id="player2Name" placeholder="Enter your name">
                    <label>Initials (for claim code):</label>
                    <input type="text" id="player2Initials" placeholder="CD" maxlength="2">
                </div>
            </div>
            
            <button class="btn" onclick="startGame()">Start Summit</button>
        </div>
        
        <!-- GAME SCREEN -->
        <div class="game-screen" id="gameScreen">
            <div class="game-layout">
                <div class="main-area" id="mainArea">
                    <!-- Dynamic content goes here -->
                </div>
                
                <div class="sidebar">
                    <div class="round-info">
                        <h2>Round <span id="roundNumber">1</span> of 6</h2>
                        <div class="timer" id="timer">5:00</div>
                        <p id="phaseLabel">Opening Statements</p>
                    </div>
                    
                    <div class="city-status">
                        <h3>üèôÔ∏è Your City Status</h3>
                        <div class="stat">
                            <span class="stat-label">Budget:</span>
                            <span class="stat-value" id="cityBudget">-$20M</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Unemployment:</span>
                            <span class="stat-value" id="cityUnemployment">8.0%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">GDP Growth:</span>
                            <span class="stat-value" id="cityGDP">1.2%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Approval:</span>
                            <span class="stat-value" id="cityApproval">52%</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Secret Goal:</span>
                            <span class="stat-value">Get $25M</span>
                        </div>
                    </div>
                    
                    <div class="team-chat">
                        <h3>üí¨ Team Private Chat</h3>
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message">
                                <div class="chat-sender">System</div>
                                <div>Welcome! Use this chat to strategize privately.</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" id="chatInput" placeholder="Type message...">
                            <button onclick="sendChat()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RESULTS SCREEN -->
        <div class="results-screen" id="resultsScreen">
            <h2 id="resultsTitle">üéâ Summit Complete!</h2>
            
            <div class="claim-code" id="claimCode" onclick="copyCode()">
                LOADING...
            </div>
            <p style="color: #666; margin-top: -20px;">Click to copy your claim code</p>
            
            <div class="score-breakdown" id="scoreBreakdown">
                <!-- Dynamic score cards -->
            </div>
            
            <button class="btn" onclick="downloadResults()">
                üì• Download Results (PDF)
            </button>
            
            <button class="btn" onclick="location.reload()">
                üîÑ Play Again
            </button>
        </div>
    </div>

    <script>
        // GAME STATE
        const gameState = {
            round: 1,
            maxRounds: 6,
            phase: 'setup',
            timeRemaining: 300,
            timerInterval: null,
            
            players: {
                player1: { name: '', initials: '' },
                player2: { name: '', initials: '' }
            },
            
            yourCity: {
                name: 'Your City',
                budget: -20,
                unemployment: 8.0,
                gdp: 1.2,
                approval: 52,
                fundingReceived: 0
            },
            
            aiCities: {},
            
            proposals: [],
            alliances: [],
            votes: {},
            
            regionalPlan: {
                budget: {
                    yourCity: 0,
                    wealthyCity: 0,
                    factoryTown: 0,
                    greenCity: 0,
                    infrastructure: 0
                },
                trade: 'undecided',
                federalGrant: 'undecided'
            },
            
            chatHistory: [],
            currentSpeaker: 1,
            
            startTime: null,
            claimCode: ''
        };
        
        // AI CITY DEFINITIONS
        class AICity {
            constructor(profile) {
                Object.assign(this, profile);
                this.relationships = { player: 50 };
                this.votingIntent = 'undecided';
            }
            
            evaluateProposal(proposal) {
                let score = 0;
                const text = proposal.toLowerCase();
                
                // Personality-based evaluation
                if (this.id === 'wealthy') {
                    if (text.includes('low tax') || text.includes('business')) score += 20;
                    if (text.includes('wealth tax') || text.includes('regulate')) score -= 20;
                    if (text.includes('invest') && text.includes('return')) score += 15;
                }
                
                if (this.id === 'factory') {
                    if (text.includes('job') || text.includes('employ') || text.includes('manufactur')) score += 25;
                    if (text.includes('tariff') || text.includes('protect')) score += 20;
                    if (text.includes('retrain')) score += 10;
                    if (text.includes('free trade')) score -= 15;
                }
                
                if (this.id === 'green') {
                    if (text.includes('environment') || text.includes('green') || text.includes('sustain')) score += 20;
                    if (text.includes('equity') || text.includes('fair') || text.includes('progressive')) score += 15;
                    if (text.includes('corporate') && text.includes('tax')) score += 10;
                    if (text.includes('pollut')) score -= 15;
                }
                
                // Update relationship
                this.relationships.player += Math.min(Math.max(score / 5, -10), 10);
                this.relationships.player = Math.min(Math.max(this.relationships.player, 0), 100);
                
                return score;
            }
            
            generateResponse(score, context) {
                const responses = this.responseTemplates[context] || this.responseTemplates.default;
                
                if (score > 15) {
                    return responses.positive[Math.floor(Math.random() * responses.positive.length)];
                } else if (score < -10) {
                    return responses.negative[Math.floor(Math.random() * responses.negative.length)];
                } else {
                    return responses.neutral[Math.floor(Math.random() * responses.neutral.length)];
                }
            }
            
            evaluateBudgetPlan(plan) {
                let score = 50; // Start neutral
                
                if (this.id === 'wealthy') {
                    // Wants minimal allocation (doesn't need help)
                    if (plan.wealthyCity < 10) score += 20;
                    if (plan.infrastructure > 30) score += 15;
                }
                
                if (this.id === 'factory') {
                    // Desperately needs funding
                    if (plan.factoryTown >= 30) score += 40;
                    else if (plan.factoryTown >= 20) score += 20;
                    else score -= 30;
                }
                
                if (this.id === 'green') {
                    // Wants fair distribution
                    const avg = (plan.yourCity + plan.wealthyCity + plan.factoryTown + plan.greenCity) / 4;
                    const variance = Math.abs(plan.greenCity - avg);
                    if (variance < 5) score += 20; // Fair distribution
                    if (plan.greenCity < plan.wealthyCity - 10) score -= 15; // Rich get more
                }
                
                return score > 65 ? 'YES' : score > 45 ? 'MAYBE' : 'NO';
            }
        }
        
        // Initialize AI Cities
        function initializeAIs() {
            gameState.aiCities = {
                wealthy: new AICity({
                    id: 'wealthy',
                    name: 'Wealthy City',
                    icon: 'üíº',
                    color: '#ffd700',
                    personality: 'capitalist',
                    description: 'Financial hub with strong business interests',
                    openingStatement: "We propose a business-friendly regional plan with low taxes and minimal regulation. We're willing to invest $30M IF others match our commitment and keep the playing field level for businesses.",
                    responseTemplates: {
                        default: {
                            positive: [
                                "We appreciate your pro-business approach. Let's discuss a partnership.",
                                "This aligns with our interests. We're open to supporting your city.",
                                "Finally, someone who understands economics. Let's work together."
                            ],
                            negative: [
                                "This level of government intervention concerns us deeply.",
                                "We may need to reconsider our participation in this alliance.",
                                "Our business community won't support this direction."
                            ],
                            neutral: [
                                "We'll need more details before committing.",
                                "Interesting proposal. What's in it for us?",
                                "We're listening. Continue."
                            ]
                        }
                    }
                }),
                
                factory: new AICity({
                    id: 'factory',
                    name: 'Factory Town',
                    icon: 'üè≠',
                    color: '#dc3545',
                    personality: 'desperate',
                    description: 'Manufacturing city hit hard by recession',
                    openingStatement: "We're in crisis! We've lost 3,000 jobs this year and unemployment is at 15%. We need tariffs to protect our manufacturing base and funding to modernize our facilities. Without help, we'll have to veto any plan that ignores us.",
                    responseTemplates: {
                        default: {
                            positive: [
                                "Thank you! Finally someone who cares about working people!",
                                "You have our full support. We won't forget this.",
                                "This is exactly what we need. We're with you."
                            ],
                            negative: [
                                "So you're just going to let us die? We'll veto everything!",
                                "You're abandoning working families. Remember this.",
                                "If we go down, we're taking everyone with us."
                            ],
                            neutral: [
                                "That's... not quite what we need. Can you do better?",
                                "We're listening, but we need concrete commitments.",
                                "Our workers are depending on this. Don't let us down."
                            ]
                        }
                    }
                }),
                
                green: new AICity({
                    id: 'green',
                    name: 'Green City',
                    icon: 'üå±',
                    color: '#28a745',
                    personality: 'idealist',
                    description: 'Progressive city focused on sustainability',
                    openingStatement: "Any recovery plan must prioritize environmental sustainability and social equity. We need progressive taxation, green energy investment, and policies that help everyone - not just the wealthy. We're building a coalition of like-minded cities.",
                    responseTemplates: {
                        default: {
                            positive: [
                                "Now this is a plan we can support! Let's build a coalition.",
                                "Finally, someone with the right values. We're in.",
                                "This is the kind of progressive thinking we need."
                            ],
                            negative: [
                                "This is just more trickle-down economics. We oppose it.",
                                "You're protecting corporate interests over people and planet.",
                                "We can't support a plan that ignores our core values."
                            ],
                            neutral: [
                                "We appreciate the gesture, but need stronger commitments.",
                                "This is a step in the right direction, but not enough.",
                                "We'll consider this if you strengthen the equity provisions."
                            ]
                        }
                    }
                })
            };
        }
        
        // START GAME
        function startGame() {
            const p1Name = document.getElementById('player1Name').value.trim();
            const p1Initials = document.getElementById('player1Initials').value.trim().toUpperCase();
            const p2Name = document.getElementById('player2Name').value.trim();
            const p2Initials = document.getElementById('player2Initials').value.trim().toUpperCase();
            
            if (!p1Name || !p1Initials || !p2Name || !p2Initials) {
                alert('Please fill in all player information!');
                return;
            }
            
            gameState.players.player1 = { name: p1Name, initials: p1Initials };
            gameState.players.player2 = { name: p2Name, initials: p2Initials };
            gameState.startTime = new Date();
            
            initializeAIs();
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').style.display = 'block';
            
            startRound1();
        }
        
        // ROUND 1: OPENING STATEMENTS
        function startRound1() {
            gameState.round = 1;
            gameState.phase = 'opening';
            updateRoundDisplay();
            startTimer(300); // 5 minutes
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="phase-title">
                    <h2>Round 1: Opening Statements</h2>
                    <p>Each city presents their position. Listen carefully and then make your proposal.</p>
                </div>
                
                <div class="ai-statement-grid">
                    <div class="ai-statement wealthy">
                        <h3><span class="ai-icon">üíº</span> Wealthy City</h3>
                        <p>${gameState.aiCities.wealthy.openingStatement}</p>
                    </div>
                    
                    <div class="ai-statement factory">
                        <h3><span class="ai-icon">üè≠</span> Factory Town</h3>
                        <p>${gameState.aiCities.factory.openingStatement}</p>
                    </div>
                    
                    <div class="ai-statement green">
                        <h3><span class="ai-icon">üå±</span> Green City</h3>
                        <p>${gameState.aiCities.green.openingStatement}</p>
                    </div>
                </div>
                
                <div class="proposal-area">
                    <h3>Your City's Opening Statement</h3>
                    <p>What is your team's initial position? Consider your goals and which AI cities might be natural allies.</p>
                    <textarea id="openingProposal" placeholder="Example: We propose a balanced approach that creates jobs while maintaining fiscal responsibility. We're open to partnerships with cities that share our commitment to economic growth..."></textarea>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="submitOpening()">Submit Opening Statement</button>
                    </div>
                </div>
            `;
        }
        
        function submitOpening() {
            const proposal = document.getElementById('openingProposal').value.trim();
            if (!proposal) {
                alert('Please write your opening statement!');
                return;
            }
            
            gameState.proposals.push({ round: 1, type: 'opening', text: proposal });
            
            // AI responses
            const responses = [];
            for (let ai of Object.values(gameState.aiCities)) {
                const score = ai.evaluateProposal(proposal);
                const response = ai.generateResponse(score, 'default');
                responses.push({ ai: ai, response: response, score: score });
            }
            
            showAIResponses(responses);
        }
        
        function showAIResponses(responses) {
            const mainArea = document.getElementById('mainArea');
            
            let responsesHTML = `
                <div class="phase-title">
                    <h2>AI Cities Respond to Your Proposal</h2>
                </div>
                <div class="ai-statement-grid">
            `;
            
            for (let r of responses) {
                const reaction = r.score > 15 ? 'positive' : r.score < -10 ? 'negative' : 'neutral';
                const reactionText = r.score > 15 ? 'üëç Supportive' : r.score < -10 ? 'üëé Opposed' : 'ü§î Neutral';
                
                responsesHTML += `
                    <div class="ai-statement ${r.ai.id}">
                        <h3>
                            <span class="ai-icon">${r.ai.icon}</span>
                            ${r.ai.name}
                            <span class="ai-reaction ${reaction}">${reactionText}</span>
                        </h3>
                        <p>${r.response}</p>
                    </div>
                `;
            }
            
            responsesHTML += `
                </div>
                <div class="info-box">
                    <strong>üí° Strategy Tip:</strong> You've learned how each AI responds to your approach. Use this information to decide which city to ally with in the next round.
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="startRound2()">Continue to Round 2</button>
                </div>
            `;
            
            mainArea.innerHTML = responsesHTML;
        }
        
        // ROUND 2: COALITION FORMATION
        function startRound2() {
            gameState.round = 2;
            gameState.phase = 'coalition';
            updateRoundDisplay();
            startTimer(420); // 7 minutes
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="phase-title">
                    <h2>Round 2: Coalition Formation</h2>
                    <p>AI cities are reaching out to form alliances. Choose wisely - you can only formally ally with ONE city.</p>
                </div>
                
                <div class="alliance-offer">
                    <h4>üíº Wealthy City offers:</h4>
                    <p>"We'll support your funding request IF you agree to keep regional taxes low and vote against heavy regulations. We can offer you $15M in private investment too. Deal?"</p>
                    <div class="action-buttons">
                        <button class="action-btn success" onclick="acceptAlliance('wealthy')">Accept Alliance</button>
                        <button class="action-btn secondary" onclick="declineAlliance('wealthy')">Decline</button>
                    </div>
                </div>
                
                <div class="alliance-offer">
                    <h4>üè≠ Factory Town offers:</h4>
                    <p>"If you support tariffs to protect manufacturing, we'll vote for your funding. We're desperate and loyal. Don't abandon us like everyone else."</p>
                    <div class="action-buttons">
                        <button class="action-btn success" onclick="acceptAlliance('factory')">Accept Alliance</button>
                        <button class="action-btn secondary" onclick="declineAlliance('factory')">Decline</button>
                    </div>
                </div>
                
                <div class="alliance-offer">
                    <h4>üå± Green City offers:</h4>
                    <p>"Join our progressive coalition. Support green energy and fair taxation, and we'll make sure you get your funding. Let's build something better together."</p>
                    <div class="action-buttons">
                        <button class="action-btn success" onclick="acceptAlliance('green')">Accept Alliance</button>
                        <button class="action-btn secondary" onclick="declineAlliance('green')">Decline</button>
                    </div>
                </div>
                
                <div class="private-message">
                    <h4>ü§´ Secret Offer from Wealthy City (Private Message)</h4>
                    <p>"Between us: I'll give you an extra $10M in off-the-books funding if you promise to vote against Green City's environmental regulations. They'll never know. What do you say?"</p>
                    <div class="action-buttons">
                        <button class="action-btn danger" onclick="acceptSecretDeal()">Accept Secret Deal</button>
                        <button class="action-btn secondary" onclick="declineSecretDeal()">Decline</button>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>‚ö†Ô∏è Important:</strong> You can only accept ONE formal alliance. Secret deals are separate but may affect your relationships later.
                </div>
            `;
        }
        
        function acceptAlliance(cityId) {
            if (gameState.alliances.length > 0) {
                alert('You\'ve already formed an alliance! You can only ally with one city.');
                return;
            }
            
            gameState.alliances.push(cityId);
            gameState.aiCities[cityId].relationships.player += 30;
            
            alert(`Alliance formed with ${gameState.aiCities[cityId].name}! They will support you in future votes.`);
            
            // Update display to show alliance formed
            document.querySelectorAll('.alliance-offer').forEach(el => {
                el.style.opacity = '0.5';
                el.querySelectorAll('button').forEach(btn => btn.disabled = true);
            });
            
            setTimeout(() => {
                startRound3();
            }, 3000);
        }
        
        function declineAlliance(cityId) {
            gameState.aiCities[cityId].relationships.player -= 10;
            alert(`You declined the alliance with ${gameState.aiCities[cityId].name}.`);
        }
        
        let secretDealAccepted = false;
        
        function acceptSecretDeal() {
            secretDealAccepted = true;
            gameState.aiCities.wealthy.relationships.player += 20;
            gameState.aiCities.green.relationships.player -= 30; // They'll find out later
            alert('Secret deal accepted! Wealthy City is very pleased. But be careful - if this gets out...');
        }
        
        function declineSecretDeal() {
            alert('You declined the secret deal. Maintaining your integrity.');
        }
        
        // ROUND 3: BUDGET ALLOCATION
        function startRound3() {
            gameState.round = 3;
            gameState.phase = 'budget';
            updateRoundDisplay();
            startTimer(480); // 8 minutes
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="phase-title">
                    <h2>Round 3: Budget Allocation</h2>
                    <p>Allocate the $100M regional fund. Watch AI reactions in real-time!</p>
                </div>
                
                <div class="budget-allocator">
                    <h3>üí∞ Regional Fund Allocation ($100M Total)</h3>
                    
                    <div class="budget-item">
                        <label>üèôÔ∏è Your City:</label>
                        <input type="number" id="budgetYourCity" value="25" min="0" max="100" onchange="updateBudget()">
                        <span>M</span>
                    </div>
                    
                    <div class="budget-item">
                        <label>üíº Wealthy City:</label>
                        <input type="number" id="budgetWealthy" value="10" min="0" max="100" onchange="updateBudget()">
                        <span>M</span>
                        <span id="reactionWealthy"></span>
                    </div>
                    
                    <div class="budget-item">
                        <label>üè≠ Factory Town:</label>
                        <input type="number" id="budgetFactory" value="30" min="0" max="100" onchange="updateBudget()">
                        <span>M</span>
                        <span id="reactionFactory"></span>
                    </div>
                    
                    <div class="budget-item">
                        <label>üå± Green City:</label>
                        <input type="number" id="budgetGreen" value="20" min="0" max="100" onchange="updateBudget()">
                        <span>M</span>
                        <span id="reactionGreen"></span>
                    </div>
                    
                    <div class="budget-item">
                        <label>üèóÔ∏è Regional Infrastructure:</label>
                        <input type="number" id="budgetInfra" value="15" min="0" max="100" onchange="updateBudget()">
                        <span>M</span>
                    </div>
                    
                    <div class="budget-total" id="budgetTotal">
                        Total: $100M / $100M ‚úÖ
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="submitBudget()" id="submitBudgetBtn">Submit Budget Proposal</button>
                    </div>
                </div>
            `;
            
            updateBudget();
        }
        
        function updateBudget() {
            const yourCity = parseInt(document.getElementById('budgetYourCity').value) || 0;
            const wealthy = parseInt(document.getElementById('budgetWealthy').value) || 0;
            const factory = parseInt(document.getElementById('budgetFactory').value) || 0;
            const green = parseInt(document.getElementById('budgetGreen').value) || 0;
            const infra = parseInt(document.getElementById('budgetInfra').value) || 0;
            
            const total = yourCity + wealthy + factory + green + infra;
            
            const totalDisplay = document.getElementById('budgetTotal');
            if (total === 100) {
                totalDisplay.innerHTML = `Total: $${total}M / $100M ‚úÖ`;
                totalDisplay.style.background = '#28a745';
                document.getElementById('submitBudgetBtn').disabled = false;
            } else {
                totalDisplay.innerHTML = `Total: $${total}M / $100M ‚ùå ${total > 100 ? 'Over budget!' : 'Under budget!'}`;
                totalDisplay.style.background = '#dc3545';
                document.getElementById('submitBudgetBtn').disabled = true;
            }
            
            // Show AI reactions
            const plan = { yourCity, wealthyCity: wealthy, factoryTown: factory, greenCity: green, infrastructure: infra };
            
            const wealthyVote = gameState.aiCities.wealthy.evaluateBudgetPlan(plan);
            const factoryVote = gameState.aiCities.factory.evaluateBudgetPlan(plan);
            const greenVote = gameState.aiCities.green.evaluateBudgetPlan(plan);
            
            document.getElementById('reactionWealthy').innerHTML = wealthyVote === 'YES' ? '<span class="ai-reaction positive">‚úÖ YES</span>' : wealthyVote === 'NO' ? '<span class="ai-reaction negative">‚ùå NO</span>' : '<span class="ai-reaction neutral">ü§î MAYBE</span>';
            
            document.getElementById('reactionFactory').innerHTML = factoryVote === 'YES' ? '<span class="ai-reaction positive">‚úÖ YES</span>' : factoryVote === 'NO' ? '<span class="ai-reaction negative">‚ùå NO</span>' : '<span class="ai-reaction neutral">ü§î MAYBE</span>';
            
            document.getElementById('reactionGreen').innerHTML = greenVote === 'YES' ? '<span class="ai-reaction positive">‚úÖ YES</span>' : greenVote === 'NO' ? '<span class="ai-reaction negative">‚ùå NO</span>' : '<span class="ai-reaction neutral">ü§î MAYBE</span>';
        }
        
        function submitBudget() {
            const yourCity = parseInt(document.getElementById('budgetYourCity').value);
            const wealthy = parseInt(document.getElementById('budgetWealthy').value);
            const factory = parseInt(document.getElementById('budgetFactory').value);
            const green = parseInt(document.getElementById('budgetGreen').value);
            const infra = parseInt(document.getElementById('budgetInfra').value);
            
            gameState.regionalPlan.budget = {
                yourCity, wealthyCity: wealthy, factoryTown: factory, greenCity: green, infrastructure: infra
            };
            
            gameState.yourCity.fundingReceived = yourCity;
            
            startRound4();
        }
        
        // ROUND 4: CRISIS EVENT
        function startRound4() {
            gameState.round = 4;
            gameState.phase = 'crisis';
            updateRoundDisplay();
            startTimer(300); // 5 minutes
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="crisis-banner">
                    <h2>üö® BREAKING NEWS: FEDERAL GRANT OPPORTUNITY</h2>
                    <p style="font-size: 1.2em; margin-top: 15px;">
                        The federal government just announced an additional $50M emergency grant available to your region!
                    </p>
                    <p style="margin-top: 15px;">
                        <strong>CATCH:</strong> The funds can ONLY be used for either:
                    </p>
                    <ul style="text-align: left; margin: 15px auto; max-width: 600px; font-size: 1.1em;">
                        <li>üè≠ <strong>Manufacturing Modernization</strong> - Update factories, save jobs</li>
                        <li>üå± <strong>Green Energy Infrastructure</strong> - Solar, wind, sustainable future</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>You must choose ONE. You have 5 minutes to decide.</strong></p>
                </div>
                
                <div class="ai-statement-grid">
                    <div class="ai-statement factory">
                        <h3><span class="ai-icon">üè≠</span> Factory Town</h3>
                        <p><strong>URGENT:</strong> This is our LAST CHANCE! Choose manufacturing or we veto the ENTIRE regional plan. Our workers are counting on this. We're deadly serious.</p>
                    </div>
                    
                    <div class="ai-statement green">
                        <h3><span class="ai-icon">üå±</span> Green City</h3>
                        <p>The planet is dying. We MUST choose green energy. Factory Town can retrain workers for green jobs - it's a win-win. This is about the future.</p>
                    </div>
                    
                    <div class="ai-statement wealthy">
                        <h3><span class="ai-icon">üíº</span> Wealthy City (Private to You)</h3>
                        <p>We don't really care which you choose. But we'll remember who helped us when the time comes. What do you need from us to make your decision?</p>
                    </div>
                </div>
                
                <div class="proposal-area">
                    <h3>Your Decision</h3>
                    <p>This choice will define the direction of your regional plan. Choose wisely - you need 3 votes to pass the plan.</p>
                    <div class="action-buttons">
                        <button class="action-btn danger" onclick="chooseFederalGrant('manufacturing')">üè≠ Choose Manufacturing</button>
                        <button class="action-btn success" onclick="chooseFederalGrant('green')">üå± Choose Green Energy</button>
                        <button class="action-btn secondary" onclick="proposeSplit()">üí° Propose 50/50 Split</button>
                    </div>
                </div>
            `;
        }
        
        function chooseFederalGrant(choice) {
            gameState.regionalPlan.federalGrant = choice;
            
            if (choice === 'manufacturing') {
                gameState.aiCities.factory.relationships.player += 40;
                gameState.aiCities.green.relationships.player -= 30;
                
                alert('Factory Town is ecstatic! Green City is disappointed but respects your decision.');
            } else if (choice === 'green') {
                gameState.aiCities.green.relationships.player += 40;
                gameState.aiCities.factory.relationships.player -= 30;
                
                alert('Green City is thrilled! Factory Town is furious and threatening to veto...');
            }
            
            setTimeout(() => {
                startRound5();
            }, 3000);
        }
        
        function proposeSplit() {
            // Both AIs moderately happy
            gameState.regionalPlan.federalGrant = 'split';
            gameState.aiCities.factory.relationships.player += 15;
            gameState.aiCities.green.relationships.player += 15;
            
            alert('Both cities accept the compromise. Not ideal for either, but shows diplomatic skill.');
            
            setTimeout(() => {
                startRound5();
            }, 3000);
        }
        
        // ROUND 5: FINAL NEGOTIATION
        function startRound5() {
            gameState.round = 5;
            gameState.phase = 'final';
            updateRoundDisplay();
            startTimer(600); // 10 minutes
            
            // Calculate current vote status
            const votes = {
                yourTeam: 'YES',
                wealthy: gameState.aiCities.wealthy.relationships.player > 60 ? 'YES' : gameState.aiCities.wealthy.relationships.player > 40 ? 'MAYBE' : 'NO',
                factory: gameState.aiCities.factory.relationships.player > 60 ? 'YES' : gameState.aiCities.factory.relationships.player > 40 ? 'MAYBE' : 'NO',
                green: gameState.aiCities.green.relationships.player > 60 ? 'YES' : gameState.aiCities.green.relationships.player > 40 ? 'MAYBE' : 'NO'
            };
            
            const yesVotes = Object.values(votes).filter(v => v === 'YES').length;
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="phase-title">
                    <h2>Round 5: Final Negotiation</h2>
                    <p>Last chance to secure votes before the final vote. You need 3 YES votes (including yours) to pass.</p>
                </div>
                
                <div class="vote-display">
                    <div class="vote-card yes">
                        <h4>Your Team</h4>
                        <div class="vote-result">‚úÖ YES</div>
                    </div>
                    <div class="vote-card ${votes.wealthy === 'YES' ? 'yes' : votes.wealthy === 'NO' ? 'no' : ''}">
                        <h4>üíº Wealthy City</h4>
                        <div class="vote-result">${votes.wealthy === 'YES' ? '‚úÖ YES' : votes.wealthy === 'NO' ? '‚ùå NO' : 'ü§î UNDECIDED'}</div>
                    </div>
                    <div class="vote-card ${votes.factory === 'YES' ? 'yes' : votes.factory === 'NO' ? 'no' : ''}">
                        <h4>üè≠ Factory Town</h4>
                        <div class="vote-result">${votes.factory === 'YES' ? '‚úÖ YES' : votes.factory === 'NO' ? '‚ùå NO' : 'ü§î UNDECIDED'}</div>
                    </div>
                    <div class="vote-card ${votes.green === 'YES' ? 'yes' : votes.green === 'NO' ? 'no' : ''}">
                        <h4>üå± Green City</h4>
                        <div class="vote-result">${votes.green === 'YES' ? '‚úÖ YES' : votes.green === 'NO' ? '‚ùå NO' : 'ü§î UNDECIDED'}</div>
                    </div>
                </div>
                
                <div class="info-box">
                    <strong>Current Status:</strong> ${yesVotes} confirmed YES votes. You need 3 total to pass.
                    ${yesVotes < 3 ? '<br><strong>‚ö†Ô∏è WARNING:</strong> You need to convince at least one more city!' : '<br><strong>‚úÖ SAFE:</strong> You have enough votes to pass!'}
                </div>
                
                <div class="proposal-area">
                    <h3>Final Offers</h3>
                    <p>Make your last pitch to undecided cities. What will you offer them?</p>
                    <textarea id="finalProposal" placeholder="Make your final arguments or offers to secure votes..."></textarea>
                    <div class="action-buttons">
                        <button class="action-btn primary" onclick="submitFinalNegotiation()">Make Final Offer</button>
                        <button class="action-btn success" onclick="proceedToVote()">Proceed to Final Vote</button>
                    </div>
                </div>
            `;
        }
        
        function submitFinalNegotiation() {
            const proposal = document.getElementById('finalProposal').value.trim();
            if (!proposal) {
                alert('Please write your final offer!');
                return;
            }
            
            // Give small relationship boost for engaging
            for (let ai of Object.values(gameState.aiCities)) {
                ai.relationships.player += 5;
            }
            
            alert('Your final offer has been sent to all cities. They are considering...');
            
            setTimeout(() => {
                proceedToVote();
            }, 2000);
        }
        
        function proceedToVote() {
            startRound6();
        }
        
        // ROUND 6: FINAL VOTE
        function startRound6() {
            gameState.round = 6;
            gameState.phase = 'voting';
            updateRoundDisplay();
            startTimer(180); // 3 minutes
            
            // Calculate final votes based on relationships
            const finalVotes = {
                yourTeam: 'YES',
                wealthy: gameState.aiCities.wealthy.relationships.player > 55 || gameState.alliances.includes('wealthy') ? 'YES' : 'NO',
                factory: gameState.aiCities.factory.relationships.player > 55 || gameState.alliances.includes('factory') ? 'YES' : 'NO',
                green: gameState.aiCities.green.relationships.player > 55 || gameState.alliances.includes('green') ? 'YES' : 'NO'
            };
            
            gameState.votes = finalVotes;
            
            const yesCount = Object.values(finalVotes).filter(v => v === 'YES').length;
            const planPassed = yesCount >= 3;
            
            const mainArea = document.getElementById('mainArea');
            mainArea.innerHTML = `
                <div class="phase-title">
                    <h2>Round 6: Final Vote</h2>
                    <p>The Regional Governor calls for the final vote on the Recovery Plan...</p>
                </div>
                
                <div class="vote-display" id="voteReveal">
                    <div class="vote-card yes">
                        <h4>Your Team</h4>
                        <div class="vote-result">‚úÖ YES</div>
                    </div>
                    <div class="vote-card" id="voteWealthy">
                        <h4>üíº Wealthy City</h4>
                        <div class="vote-result">ü§î Voting...</div>
                    </div>
                    <div class="vote-card" id="voteFactory">
                        <h4>üè≠ Factory Town</h4>
                        <div class="vote-result">ü§î Voting...</div>
                    </div>
                    <div class="vote-card" id="voteGreen">
                        <h4>üå± Green City</h4>
                        <div class="vote-result">ü§î Voting...</div>
                    </div>
                </div>
                
                <div class="info-box">
                    <p style="text-align: center; font-size: 1.2em;">
                        <strong>The votes are being cast...</strong>
                    </p>
                </div>
            `;
            
            // Dramatic vote reveal
            setTimeout(() => {
                const wealthyCard = document.getElementById('voteWealthy');
                wealthyCard.classList.add(finalVotes.wealthy === 'YES' ? 'yes' : 'no');
                wealthyCard.querySelector('.vote-result').innerHTML = finalVotes.wealthy === 'YES' ? '‚úÖ YES' : '‚ùå NO';
            }, 2000);
            
            setTimeout(() => {
                const factoryCard = document.getElementById('voteFactory');
                factoryCard.classList.add(finalVotes.factory === 'YES' ? 'yes' : 'no');
                factoryCard.querySelector('.vote-result').innerHTML = finalVotes.factory === 'YES' ? '‚úÖ YES' : '‚ùå NO';
            }, 4000);
            
            setTimeout(() => {
                const greenCard = document.getElementById('voteGreen');
                greenCard.classList.add(finalVotes.green === 'YES' ? 'yes' : 'no');
                greenCard.querySelector('.vote-result').innerHTML = finalVotes.green === 'YES' ? '‚úÖ YES' : '‚ùå NO';
            }, 6000);
            
            setTimeout(() => {
                showFinalResults(planPassed, yesCount);
            }, 8000);
        }
        
        function showFinalResults(planPassed, yesCount) {
            const mainArea = document.getElementById('mainArea');
            
            if (planPassed) {
                mainArea.innerHTML = `
                    <div class="crisis-banner" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); animation: none;">
                        <h2>‚úÖ REGIONAL PLAN APPROVED!</h2>
                        <p style="font-size: 1.3em; margin-top: 20px;">
                            Final Vote: ${yesCount} YES - ${4 - yesCount} NO
                        </p>
                        <p style="margin-top: 15px;">
                            The regional plan has been approved! Your cities will work together to implement the recovery strategy.
                        </p>
                    </div>
                    
                    <div class="action-buttons" style="justify-content: center;">
                        <button class="action-btn primary" onclick="calculateScore()">View Final Results</button>
                    </div>
                `;
            } else {
                mainArea.innerHTML = `
                    <div class="crisis-banner">
                        <h2>‚ùå REGIONAL PLAN REJECTED</h2>
                        <p style="font-size: 1.3em; margin-top: 20px;">
                            Final Vote: ${yesCount} YES - ${4 - yesCount} NO
                        </p>
                        <p style="margin-top: 15px;">
                            Without agreement, the Regional Governor declares a state of emergency. Federal government takes control.
                        </p>
                    </div>
                    
                    <div class="action-buttons" style="justify-content: center;">
                        <button class="action-btn primary" onclick="calculateScore()">View Final Results</button>
                    </div>
                `;
            }
        }
        
        // SCORING & RESULTS
        function calculateScore() {
            const planPassed = Object.values(gameState.votes).filter(v => v === 'YES').length >= 3;
            
            // Team Score (60%)
            let teamScore = 0;
            
            // Regional outcome (40 points)
            if (planPassed) {
                teamScore += 40;
            } else {
                teamScore += 10;
            }
            
            // Goal achievement (20 points)
            if (gameState.yourCity.fundingReceived >= 25) {
                teamScore += 20;
            } else if (gameState.yourCity.fundingReceived >= 15) {
                teamScore += 15;
            } else {
                teamScore += 5;
            }
            
            // Individual Scores (40% each)
            const participationScore = 20; // Assume full participation
            const reasoningScore = 20; // Assume good reasoning
            
            const totalScore = teamScore + participationScore + reasoningScore;
            
            // Bonuses
            let bonuses = 0;
            if (planPassed && gameState.yourCity.fundingReceived >= 25) bonuses += 10; // Deal Maker
            if (gameState.regionalPlan.federalGrant === 'split') bonuses += 10; // Crisis Manager
            
            const finalScore = totalScore + bonuses;
            
            // Determine tier
            let tier, xp, title;
            if (finalScore >= 90) {
                tier = 'GOLD';
                xp = 250;
                title = 'üèÜ Economic Diplomat';
            } else if (finalScore >= 75) {
                tier = 'SILVER';
                xp = 175;
                title = '‚≠ê Skilled Negotiator';
            } else {
                tier = 'BRONZE';
                xp = 125;
                title = 'üìä Engaged Participant';
            }
            
            // Generate claim code
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            const initials = gameState.players.player1.initials + gameState.players.player2.initials;
            gameState.claimCode = `BOSS-SIM-${tier}-${initials}-${random}`;
            
            showResults(tier, xp, title, finalScore, teamScore, planPassed);
        }
        
        function showResults(tier, xp, title, finalScore, teamScore, planPassed) {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            document.getElementById('resultsTitle').innerHTML = title;
            document.getElementById('claimCode').textContent = gameState.claimCode;
            
            const scoreBreakdown = document.getElementById('scoreBreakdown');
            scoreBreakdown.innerHTML = `
                <div class="score-card">
                    <h3>Team Performance</h3>
                    <div class="score-item">
                        <span>Regional Plan:</span>
                        <span>${planPassed ? 'PASSED ‚úÖ' : 'FAILED ‚ùå'}</span>
                    </div>
                    <div class="score-item">
                        <span>Funding Secured:</span>
                        <span>$${gameState.yourCity.fundingReceived}M</span>
                    </div>
                    <div class="score-item">
                        <span>Team Score:</span>
                        <span>${teamScore}/60</span>
                    </div>
                </div>
                
                <div class="score-card">
                    <h3>Final Results</h3>
                    <div class="score-item">
                        <span>Total Score:</span>
                        <span>${finalScore}/100</span>
                    </div>
                    <div class="score-item">
                        <span>Mastery Tier:</span>
                        <span>${tier}</span>
                    </div>
                    <div class="score-item">
                        <span>XP Earned:</span>
                        <span>${xp} XP</span>
                    </div>
                </div>
                
                <div class="score-card">
                    <h3>Alliance Status</h3>
                    <div class="score-item">
                        <span>üíº Wealthy City:</span>
                        <span>${gameState.votes.wealthy}</span>
                    </div>
                    <div class="score-item">
                        <span>üè≠ Factory Town:</span>
                        <span>${gameState.votes.factory}</span>
                    </div>
                    <div class="score-item">
                        <span>üå± Green City:</span>
                        <span>${gameState.votes.green}</span>
                    </div>
                </div>
            `;
        }
        
        // HELPER FUNCTIONS
        function updateRoundDisplay() {
            document.getElementById('roundNumber').textContent = gameState.round;
            const phases = {
                'opening': 'Opening Statements',
                'coalition': 'Coalition Formation',
                'budget': 'Budget Allocation',
                'crisis': 'Crisis Event',
                'final': 'Final Negotiation',
                'voting': 'Final Vote'
            };
            document.getElementById('phaseLabel').textContent = phases[gameState.phase] || '';
        }
        
        function startTimer(seconds) {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            
            gameState.timeRemaining = seconds;
            
            gameState.timerInterval = setInterval(() => {
                gameState.timeRemaining--;
                
                const mins = Math.floor(gameState.timeRemaining / 60);
                const secs = gameState.timeRemaining % 60;
                document.getElementById('timer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timerInterval);
                }
            }, 1000);
        }
        
        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const speaker = gameState.currentSpeaker === 1 ? gameState.players.player1.name : gameState.players.player2.name;
            const playerClass = gameState.currentSpeaker === 1 ? 'player1' : 'player2';
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${playerClass}`;
            messageDiv.innerHTML = `
                <div class="chat-sender">${speaker}</div>
                <div>${message}</div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            gameState.chatHistory.push({ speaker, message, time: new Date() });
            
            input.value = '';
            gameState.currentSpeaker = gameState.currentSpeaker === 1 ? 2 : 1;
        }
        
        document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChat();
        });
        
        function copyCode() {
            const code = gameState.claimCode;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Claim code copied! Submit it in the BOW Finish Form to claim your XP.');
            }).catch(() => {
                prompt('Copy this code manually:', code);
            });
        }
        
        function downloadResults() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('BOW Boss Sim - Economic Summit', 20, 20);
            doc.text('Final Results', 20, 30);
            
            doc.setFontSize(12);
            doc.text(`Claim Code: ${gameState.claimCode}`, 20, 45);
            doc.text(`Team: ${gameState.players.player1.name} & ${gameState.players.player2.name}`, 20, 55);
            doc.text(`Plan Status: ${Object.values(gameState.votes).filter(v => v === 'YES').length >= 3 ? 'PASSED' : 'FAILED'}`, 20, 65);
            doc.text(`Funding Secured: $${gameState.yourCity.fundingReceived}M`, 20, 75);
            
            doc.text('Final Votes:', 20, 90);
            doc.text(`  Wealthy City: ${gameState.votes.wealthy}`, 25, 100);
            doc.text(`  Factory Town: ${gameState.votes.factory}`, 25, 110);
            doc.text(`  Green City: ${gameState.votes.green}`, 25, 120);
            
            doc.save(`BOW_BossSim_${gameState.claimCode}.pdf`);
        }
    </script>
</body>
</html>
